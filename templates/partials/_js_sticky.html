<script>


    function strip(str) {
        // strips out leading and trailing spaces
        return str.replace(/^\s+|\s+$/gm, '');
    }

    $("body").overlayScrollbars({});

    {# -------------------------------------------------------------------------------------------------------- #}

    $(document).on("click", "#palette", function () {
        //console.log("Palette cc=lciked")
        let paletteDiv = this.parentElement.nextElementSibling
        $(paletteDiv).toggleClass('colors').toggleClass("colors openDivs");
    });


    function resetNoteForm() {
        $('#createTitleInput').val('')
        $('#createDescriptionInput').val('')
        let note = $('#noteCreator').find('#bg')

        $('#noteCreator').find('#allColor').removeClass('openDivs')
        setNoteBackgroundColor(note, 'white')
        selectedCircleRemoval()
        $('#noteCreator').find('#allColor').find('#circle_white').toggleClass('selected')

    }

    function setNoteBackgroundColor(element, color) {
        $(element).removeAttr('class').addClass("single-note add-note " + color);
    }

    $(document).on("click", ".circle", function () {
        // console.log(this)
        selectedCircleRemoval()
        $(this).toggleClass('selected')

        let color = this.getAttribute('data-color')
        //console.log(this)
        let parentDiv = null
        if (this.parentElement.getAttribute('data-new-note')) {
            parentDiv = this.parentElement.parentElement.parentElement
        } else {
            parentDiv = this.parentElement.parentElement
        }

        setNoteBackgroundColor(parentDiv, color)
    });

    function selectedCircleRemoval() {
        let allCircles = $('.circle')
        // console.log("allCircles: ",allCircles)
        for (let i = 0; i < allCircles.length; i++) {
            $(allCircles[i]).removeClass('selected')
        }
    }

    {# -------------------------------------------------------------------------------------------------------- #}

    function appendNoteToDOM(noteTitle, noteDescription, selectedColor) {
        let noteCard = document.createElement('div')
        noteCard.className = 'col-md-4 col-sm-6'
        noteCard.innerHTML = `   <form id="UpdateNoteForm">
                                <div id="bg" class="single-note ${selectedColor}">

                                    <span class="notDone">
                                            <label class="my-checkbox">
                                                <input type="checkbox" value="" id="id_is_done">
                                                <i class="checked fa-check-square fas"></i>
                                                <i class="unchecked fa-check-square far"></i>
                                            </label>
                                    </span>

                                    <input id="new_title" name="title" type="text" class=""
                                           maxlength="20" placeholder="Type a title ..."
                                           value="${noteTitle}" readonly>

                                    <small>Last Updated:{% now 'D, dS M Y' %}</small>
                                    <hr>
                                    <textarea id="desc"  readonly name="description"> ${noteDescription}</textarea>

                                    <p id="descPara" class="expand" style="display: none;">${noteDescription}</p>

                                    <div class="meta">
                                        <span style="display: none;">
                                            <button name="update" id="update_btn" class="mark btn btn-lg" type="button">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </span>

                                        <span id="pencil" ><i class="fas fa-pencil-alt"></i></span>
                                        <span id="palette" class="">
                                            <i class="fas fa-palette"></i>
                                        </span>

                                        <span>
                                            <button id="delete_btn" type="button" name="delete_btn"
                                                    class="mark btn btn-lg">
                                                <i class="far fa-trash-alt"></i>
                                            </button>
                                        </span>

                                        <span id="expand"><i class="fas fa-expand"></i></span>
                                        <span id="link" data-clipboard-text="">
                                            <i class="fas fa-link"></i>
                                        </span>
                                    </div>

                                    <div id="allColor" class="colors">
                                        <div id="circle_blue" class="circle blue" data-color="blue">
                                        </div>
                                        <div id="circle_yellow" class="circle yellow" data-color="yellow">
                                        </div>
                                        <div id="circle_red" class="circle red" data-color="red">
                                        </div>
                                        <div id="circle_purple" class="circle purple" data-color="purple">
                                        </div>
                                        <div id="circle_green" class="circle green" data-color="green">
                                        </div>
                                        <div id="circle_white" class="circle whiteCircle" data-color="white">
                                        </div>
                                    </div>
                                    <div id="copied" class="copied"> Note link copied !</div>
                                </div>
                            </form>
                            `

        //$(noteCard).hide()
        $('#all-notes').prepend(noteCard)
        //$(noteCard).fadeIn(700)
        let circle = $(noteCard).find('#circle_' + selectedColor)
        //console.log(circle)
        circle.toggleClass('selected')

        // TODO : timeago.js should be used for real time update

    }

    $('#createNote').submit(function (event) {
        event.preventDefault();

        let createTitleInput = $('#createTitleInput').val()
        let createDescriptionInput = $('#createDescriptionInput').val()

        let selectedColor = $(this).find('.selected').attr('data-color')
        console.log("selectedColor: ", selectedColor)
        if (strip(createTitleInput).length > 1) {
            resetNoteForm()
            appendNoteToDOM(createTitleInput, createDescriptionInput, selectedColor)
            $("#notes").click()
        } else {
            console.log("You need to input a title")
            alert("You need to input a title")
            // TODO : Notify.js should be used for notifications
        }

    });


    {# -------------------------------------------------------------------------------------------------------- #}


    $(document).on("click", "#pencil", function () {
        console.log("Pencil clciked")
        //console.log(this)

        let paragraph = this.parentElement.previousElementSibling
        let textArea = this.parentElement.previousElementSibling.previousElementSibling
        let input = this.parentElement.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling

        //console.log("textArea", textArea)
        //console.log("input", input)

        if ($(textArea).is(":hidden")) {
            $(paragraph).hide()
            $(textArea).show()
        }

        textArea.removeAttribute('readonly')
        input.removeAttribute('readonly')

        $(this.previousElementSibling).show() // show update btn
        $(this).hide() // hide pencil
    });

    $(document).on("click", "#update_btn", function (e) {
        e.preventDefault()
        console.log("update_btn clciked")
        // console.log(this)

        let textArea = this.parentElement.parentElement.previousElementSibling.previousElementSibling
        let input = this.parentElement.parentElement.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling.previousElementSibling

        //console.log("textArea", textArea)
        //console.log("input", input)

        textArea.setAttribute('readonly', 'true')
        input.setAttribute('readonly', 'true')

        $(this.parentElement).hide() //hide update btn
        $(this.parentElement.nextElementSibling).show() // show pencil
    });

    $(document).on("click", "#delete_btn", function (e) {
        e.preventDefault()
        console.log("delete_btn clciked")
        // console.log(this)
        let noteCard = this.parentElement.parentElement.parentElement.parentElement.parentElement
        console.log("Deleting -", noteCard)

        alertify.confirm('Confirm Delete', 'Are you sure you want to delete this Note', function () {

            $(noteCard).fadeOut('600')
            $(noteCard).remove()

            {#alertify.success('Note deleted');#}
            console.log("Note deleted")
        }, function () {
            console.log("Note cancelled ")
        }).set('resizable', true).set('labels', {ok: 'Yes', cancel: 'Nah, cancel'});

    });


    $(document).on("click", "#expand", function () {
        console.log("Expand clciked")
        //console.log(this)

        let paragraph = this.parentElement.previousElementSibling
        let textArea = this.parentElement.previousElementSibling.previousElementSibling

        //console.log("paragraph: ",paragraph)
        //console.log("textArea: ",textArea)

        if ($(paragraph).is(":hidden")) {
            //console.log("para is hidden so will show now")
            $(paragraph).show()
            $(textArea).hide()
        } else {
            //console.log("para is shown so will hidden now")
            $(paragraph).hide()
            $(textArea).show()
        }

    });


    {# -------------------------------------------------------------------------------------------------------- #}

    $(document).on("keyup", "#desc", function () {
        // Automatically sets the paragraph text to the description text when a key is clicked
        // console.log(this.value)
        let descriptionValue = this.value

        let paragraph = this.nextElementSibling
        //console.log(paragraph)
        $(paragraph).text(descriptionValue)

    });


    $(document).on("click", "#id_is_done", function (event) {
        //console.log("Chekcer")
        //console.log(this)
        let input = this.parentElement.parentElement.nextElementSibling
        let description = this.parentElement.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling
        let paragraph = this.parentElement.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling.nextElementSibling

        if ($(this).prop('checked')) {
            console.log("Checked")
            $(input).addClass('isDone')
            $(description).addClass('isDone')
            $(paragraph).addClass('isDone')

        } else {
            console.log("Unchceked")
            $(input).removeClass('isDone')
            $(description).removeClass('isDone')
            $(paragraph).removeClass('isDone')

        }

    });

</script>
